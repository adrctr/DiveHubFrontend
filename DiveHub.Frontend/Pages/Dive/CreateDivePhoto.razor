@page "/dive/{diveId:int}/photos"
<MudPaper Elevation="4" Class="pa-4 ma-6">
    <MudText Typo="Typo.h6">Ajouter des photos</MudText>

    <MudFileUpload T="IBrowserFile" FilesChanged="UploadFiles">
        <ActivatorContent>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.CloudUpload">
                Upload Files
            </MudButton>
        </ActivatorContent>
    </MudFileUpload>

    @* <MudList> *@
    @*     @foreach (var file in SelectedFiles) *@
    @*     { *@
    @*         <MudListItem> *@
    @*             <MudText>@file.Name (@file.Size / 1024 KB)</MudText> *@
    @*             <MudButton Color="Color.Error" OnClick="() => RemoveFile(file)">X</MudButton> *@
    @*         </MudListItem> *@
    @*     } *@
    @* </MudList> *@

    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="UploadFiles" Disabled="!(SelectedFiles.Any())">
        Upload
    </MudButton>
</MudPaper>

@code {
    [Inject] private HttpClient Http { get; set; } = default!;
    
    [Parameter] public int DiveId { get; set; }

    private List<IBrowserFile> SelectedFiles = new();

    private void OnFilesSelected(IEnumerable<IBrowserFile> files)
    {
        SelectedFiles.AddRange(files);
    }

    private void RemoveFile(IBrowserFile file)
    {
        SelectedFiles.Remove(file);
    }

    private async Task UploadFiles()
    {
        var content = new MultipartFormDataContent();

        foreach (var file in SelectedFiles)
        {
            var stream = file.OpenReadStream(maxAllowedSize: 10485760); // 10MB max
            var fileContent = new StreamContent(stream);
            fileContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue(file.ContentType);
            content.Add(fileContent, "files", file.Name);
        }
        Console.WriteLine(content);
        var response = await Http.PostAsync("/api/dive/upload", content);

        if (response.IsSuccessStatusCode)
        {
            SelectedFiles.Clear();
            Console.WriteLine("Upload r√©ussi !");
        }
        else
        {
            Console.WriteLine("Erreur lors de l'upload");
        }
    }
}